<!DOCTYPE html>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">
    <html>
    <head>
        <title>Using web3 API with MetaMask</title>
        <script src="https://cdn.jsdelivr.net/npm/web3@1.2.2/dist/web3.min.js"></script>
        <script src="{{url_for('static', filename='bundle.js')}}"></script>
        <link rel="stylesheet" href="{{url_for('static', filename='styles.css')}}">
        <script>

            let accounts;
            let public_keys;

            async function check_metamask(){
                if (window.ethereum) {
                    window.web3 = new Web3(ethereum);
                    await ethereum.enable()
                        .then(() => {
                            console.log("Ethereum enabled");
                        })
                        .catch(() => {
                            console.warn('User didn\'t allow access to accounts.');
                            waitLogin();
                        });
                } else {
                    console.log("Non-Ethereum browser detected. You should consider installing MetaMask.");
                    return;
                }
            }

            async function get_accounts() {
                await web3.eth.getAccounts(function (err, acc) {
                    if (err != null) {
                        self.setStatus("There was an error fetching your accounts");
                        return;
                    }
                    if (acc.length > 0) {
                        console.log('Accounts:')
                        console.log(acc);

                        accounts = acc;
                    }
                });
            }

            async function get_public_keys(){
                await ethereum
                .request({
                  method: 'eth_getEncryptionPublicKey',
                  params: [accounts[0]], // you must have access to the specified account
                })
                .then((result) => {
                    console.log('The public key for the first account is:')
                    console.log(result);
                    public_keys = result;
                })
                .catch((error) => {
                  if (error.code === 4001) {
                    // EIP-1193 userRejectedRequest error
                    console.log("We can't encrypt anything without the key.");
                  } else {
                    console.error(error);
                  }
                });
            }

            function encrypt_wrapper(message) {
                key = public_keys;

                console.log(my_encrypt)

                encrypted = my_encrypt(key, message);

                console.log(encrypted);
            }

            function decrypt(message) {
                ethereum
                .request({
                  method: 'eth_decrypt',
                  params: [message, accounts[0]],
                })
                .then((decryptedMessage) =>
                  console.log('The decrypted message is:', decryptedMessage)
                )
                .catch((error) => console.log(error.message));
            }

            function call_python(){
                //create XMLHttpRequest object
                const xhr = new XMLHttpRequest()
                //open a get request with the remote server URL
                xhr.open("POST", "/call_python", true)

                //EVENT HANDLERS

                //triggered when the response is completed
                xhr.onload = function() {
                    console.log(xhr.responseText)
                }

                //send the Http request
                xhr.send("Data from JS")
            }

            function call_setup(){
                //create XMLHttpRequest object
                const xhr = new XMLHttpRequest()
                //open a get request with the remote server URL
                xhr.open("POST", "/call_brownie", true)

                //EVENT HANDLERS

                //triggered when the response is completed
                xhr.onload = function() {
                    console.log(xhr.responseText);
                    document.getElementById('setup-btn').textContent  = "Success!";
                    document.getElementById('setup-btn').style.backgroundColor = "#11bf3d";
                }

                //send the Http request
                xhr.send("Data from JS")
            }

            async function login(){
                await check_metamask();
                await get_accounts();
                await get_public_keys();

                document.getElementById('login-btn').textContent  = "Success!";
                document.getElementById('login-btn').style.backgroundColor = "#11bf3d";
            }
        </script>
    </head>
    <body>
        <div id="top-buttons">
            <button id="login-btn" onclick="login()">Log In!</button>
            <input type="text" id="encrypt-input"/>
            <button onclick="encrypt_wrapper(document.getElementById('encrypt-input').value)">Encrypt message</button>
            <input type="text" id="decrypt-input"/>
            <button onclick="decrypt(document.getElementById('decrypt-input').value)">Decrypt message</button>
            <button onclick="call_python()">Call python</button>

            <button id="setup-btn" onclick="call_setup()">Setup</button>
        </div>

      <div id="main">
        <div id = "contacts">
            <div>
                <span>Address:</span>
                <span>0x71C7656EC7ab88b098defB751B7401B5f6d8976F</span>
            </div> 
            <div>
                <span>Address:</span>
                <span>0x7094a738526cC59CdB5E3806700d4Bd1b4f39e56</span>
            </div> 
            <div>
                <span>Address:</span>
                <span>0xcDFF1e1738121703679bE9839F778bb1f6527E81</span>
            </div> 
            <div class="active">
                <span>Address:</span>
                <span>0x80b6aBa3e4d22633d56Efa95708381928554A881</span>
            </div> 
            <div>
                <span>Address:</span>
                <span>0xC137B0AB0256Df59c23a8d31B0852315e16941De</span>
            </div> 
        </div>
        <div id = "received-messages">
            <span class="message-left">Hi there this is the first message</span>
            <span class="message-right">Hello this is another messagte there this is the first message</span>
            <span class="message-left">More messages coming this way</span>
        </div>
        <div id ="write-message">
            <input type="text"/>
            <button>Send</button>
        </div>
      </div>
    </body>
    </html>